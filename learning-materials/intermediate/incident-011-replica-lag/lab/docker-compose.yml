# Replica Lag Lab - Docker Compose

services:
  # Primary PostgreSQL
  primary:
    image: postgres:16-alpine
    container_name: replica-lag-primary
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      POSTGRES_REPLICATION_USER: replicator
      POSTGRES_REPLICATION_PASSWORD: replicatepass
    ports:
      - "5432:5432"
    volumes:
      - ./scripts/init-primary.sh:/docker-entrypoint-initdb.d/init-primary.sh
      - primary-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 2s

  # Replica 1 (Normal lag)
  replica1:
    image: postgres:16-alpine
    container_name: replica-lag-replica1
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"
    volumes:
      - replica1-data:/var/lib/postgresql/data
    depends_on:
      primary:
        condition: service_healthy

  # Replica 2 (Simulated lag)
  replica2:
    image: postgres:16-alpine
    container_name: replica-lag-replica2
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5434:5432"
    volumes:
      - replica2-data:/var/lib/postgresql/data
    depends_on:
      primary:
        condition: service_healthy

  # Client for experiments
  client:
    image: python:3.12-slim
    container_name: replica-lag-client
    working_dir: /workspace
    volumes:
      - ./scripts:/workspace
    depends_on:
      - primary
    command: tail -f /dev/null

  # Network partition simulator
  partition:
    image: alpine:latest
    container_name: partition-simulator
    network_mode: host
    command: tail -f /dev/null
    privileged: true

volumes:
  primary-data:
  replica1-data:
  replica2-data:
